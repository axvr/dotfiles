#!/bin/sh -e

# A simple font installer for Unix-like OSs
#
# Author:  Alex Vear (axvr)
# Licence: Unlicence

requires() {
    for i in "$@"
    do
        if [ ! "$(command -v "$i")" ]
        then
            (>&2 printf "Error: '%s' is not installed\\n" "$i")
            exit 1
        fi
    done
}

message() { printf "Installed font: %s\\n" "$1"; }

download() {
    requires "curl"
    dir="$(dirname "$FONT_DIR/$2")"
    [ -d "$dir" ] && rm -r "$dir"
    mkdir -p "$dir"
    curl -sSL "$1" -o "$FONT_DIR/$2" #2> get-font-log || die "Something"
}

die() {
    printf "Failed to install: %s\\n" "$1"
    exit 1
}

github_latest_version() {
    requires "curl"
    curl -sS "https://api.github.com/repos/$1/$2/releases/latest" |
    grep '"tag_name":' | sed 's/.*"\([^"]\+\)".*/\1/'
}

[ -z "$FONT_DIR" ] && FONT_DIR="$HOME/.fonts"

# TODO: add Liberation Sans and Mono

font_list=$(cat <<EOF
DejaVu Sans/Serif   (https://dejavu-fonts.github.io/)
Inconsolata         (http://www.levien.com/type/myfonts/inconsolata.html)
Noto Sans           (https://fonts.google.com/specimen/Noto+Sans)
Noto Serif          (https://fonts.google.com/specimen/Noto+Serif)
Roboto              (https://fonts.google.com/specimen/Roboto)
Roboto Condensed    (https://fonts.google.com/specimen/Roboto+Condensed)
Roboto Mono         (https://fonts.google.com/specimen/Roboto+Mono)
Source Code Pro     (https://adobe-fonts.github.io/source-code-pro/)
EOF
)

# Simplify installing fonts from Google Fonts
google_fonts() {
    requires "unzip"
    url="https://fonts.google.com/download?family=$(echo "$1" | sed 's/\s/%20/g')"
    download "$url" "$f/$f.zip"
    unzip -q "$FONT_DIR/$f/$f.zip" -d "$FONT_DIR/$f/"
    message "$1"
}

[ -z "$1" ] && echo "$font_list"

for f in "$@"
do 
    f="$(echo "$f" | tr '[:upper:]' '[:lower:]' | tr -s ' _-' '_')"
    case "$f" in
        roboto)             google_fonts "Roboto";;
        roboto_mono)        google_fonts "Roboto Mono";;
        roboto_condensed)   google_fonts "Roboto Condensed";;
        source_code_pro)    google_fonts "Source Code Pro";;
        noto_sans)          google_fonts "Noto Sans";;
        noto_serif)         google_fonts "Noto Serif";;
        inconsolata)        google_fonts "Inconsolata";;

        dejavu)
            requires "tar" "bzip2"
            url="http://sourceforge.net/projects/dejavu/files/dejavu/2.37/dejavu-fonts-ttf-2.37.tar.bz2"
            download "$url" "dejavu-fonts-ttf-2.37/dejavu-fonts-ttf-2.37.tar.bz2"
            tar -jxf "$FONT_DIR/dejavu-fonts-ttf-2.37/dejavu-fonts-ttf-2.37.tar.bz2" -C "$FONT_DIR/"
            message "DejaVu"
            ;;

        *)  printf "Error: Invalid font '%s'\\n" "$f";;
    esac &
done

wait
